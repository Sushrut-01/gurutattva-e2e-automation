# E2E Test Pipeline for Gurutattva Mobile and Web Application
# This pipeline runs all End-to-End test cases

trigger:
- main
- develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  pythonVersion: '3.9'
  nodeVersion: '16.x'

stages:
- stage: E2E_Tests
  displayName: 'E2E Test Execution'
  jobs:
  - job: Run_E2E_Tests
    displayName: 'Execute E2E Test Suite'
    timeoutInMinutes: 60
    steps:
    - task: UsePythonVersion@0
      displayName: 'Use Python $(pythonVersion)'
      inputs:
        versionSpec: '$(pythonVersion)'
        addToPath: true

    - script: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      displayName: 'Install Python Dependencies'

    - script: |
        # Install Node.js for Appium
        curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
        sudo apt-get install -y nodejs
        
        # Install Appium
        npm install -g appium@next
        npm install -g appium-doctor
        
        # Install Android SDK
        sudo apt-get update
        sudo apt-get install -y openjdk-8-jdk
        export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
        
        # Download and setup Android SDK
        wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip commandlinetools-linux-9477386_latest.zip
        mkdir -p $ANDROID_HOME/cmdline-tools/latest
        mv cmdline-tools/* $ANDROID_HOME/cmdline-tools/latest/
        rm -rf cmdline-tools commandlinetools-linux-9477386_latest.zip
        
        # Setup environment variables
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools" >> $GITHUB_ENV
        
        # Accept licenses and install platform tools
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-30" "build-tools;30.0.3"
        
        # Create and start emulator
        $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd -n test_emulator -k "system-images;android-30;google_apis;x86_64" --force
        $ANDROID_HOME/emulator/emulator -avd test_emulator -no-audio -no-window &
        
        # Wait for emulator to boot
        $ANDROID_HOME/platform-tools/adb wait-for-device
        $ANDROID_HOME/platform-tools/adb shell 'while [[ -z $(getprop sys.boot_completed | tr -d '\r') ]]; do sleep 1; done'
        
        # Start Appium server
        appium --log-level error &
        sleep 10
        
        # Install APK
        $ANDROID_HOME/platform-tools/adb install -r test_data/gurutattva.apk
        
        # Run E2E tests
        robot --outputdir results --variable BROWSER:headlesschrome tests/
      displayName: 'Setup Environment and Run E2E Tests'
      env:
        ANDROID_HOME: /usr/local/lib/android/sdk

    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'results/output.xml'
        testRunTitle: 'E2E Test Results - Build $(Build.BuildNumber)'
        mergeTestResults: true
        failTaskOnFailedTests: false

    - task: Bash@3
      displayName: 'Fix Screenshot Filenames'
      condition: always()
      inputs:
        targetType: 'inline'
        script: |
          #!/usr/bin/env bash
          
          echo "=== Fixing Screenshot Filenames ==="
          if [ -d "results/Screenshot" ]; then
            cd results/Screenshot
            for file in *:*; do
              if [ -f "$file" ]; then
                # Replace colons with underscores
                new_name=$(echo "$file" | sed 's/:/_/g')
                echo "Renaming: $file -> $new_name"
                mv "$file" "$new_name"
              fi
            done
            cd ../..
            echo "Screenshot filenames fixed!"
          else
            echo "No Screenshot directory found"
          fi

    - task: PublishBuildArtifacts@1
      displayName: 'Publish E2E Test Artifacts'
      condition: always()
      inputs:
        pathToPublish: 'results'
        artifactName: 'e2e-test-results-$(Build.BuildNumber)'
        publishLocation: 'Container'

    - task: Bash@3
      displayName: 'Cleanup Resources'
      condition: always()
      inputs:
        targetType: 'inline'
        script: |
          #!/usr/bin/env bash
          echo "=== Cleaning up resources ==="
          
          # Kill Appium processes
          pkill -f appium || true
          
          # Kill emulator processes
          pkill -f emulator || true
          
          # Kill ADB processes
          pkill -f adb || true
          
          echo "Cleanup completed"

    - task: PowerShell@2
      displayName: 'Send E2E Test Results Email'
      condition: always()
      inputs:
        targetType: 'inline'
        script: |
          # Email configuration
          $smtpServer = "mail.smtp2go.com"
          $smtpPort = 2525
          $smtpUsername = "legalai@rysun.com"
          $smtpPassword = "Hey#u5528"
          $fromEmail = "legalai@rysun.com"
          $toEmail = "warish.kumar@rysun.com"
          
          # Create email message
          $subject = "E2E Test Results - Build $(Build.BuildNumber) - $(Build.SourceBranchName)"
          $body = @"
          <html>
          <body>
          <h2>E2E Test Execution Results</h2>
          <p><strong>Build Number:</strong> $(Build.BuildNumber)</p>
          <p><strong>Branch:</strong> $(Build.SourceBranchName)</p>
          <p><strong>Build Status:</strong> $(Agent.JobStatus)</p>
          <p><strong>Test Results:</strong> <a href="$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)">View Build Results</a></p>
          
          <h3>Test Artifacts:</h3>
          <ul>
          <li>Test Report: <a href="$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)&view=artifacts">Download Artifacts</a></li>
          </ul>
          
          <p>This is an automated message from the E2E Test Pipeline.</p>
          </body>
          </html>
          "@
          
          # Send email
          $smtp = New-Object System.Net.Mail.SmtpClient($smtpServer, $smtpPort)
          $smtp.EnableSsl = $true
          $smtp.Credentials = New-Object System.Net.NetworkCredential($smtpUsername, $smtpPassword)
          
          $mailMessage = New-Object System.Net.Mail.MailMessage($fromEmail, $toEmail, $subject, $body)
          $mailMessage.IsBodyHtml = $true
          
          try {
              $smtp.Send($mailMessage)
              Write-Host "E2E Test results email sent successfully"
          }
          catch {
              Write-Host "Failed to send email: $($_.Exception.Message)"
          }
          finally {
              $smtp.Dispose()
              $mailMessage.Dispose()
          }
